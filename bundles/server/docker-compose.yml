services:
  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
    depends_on:
      - oauth2-proxy
      - socat-frontend
    restart: unless-stopped

  casdoor:
    image: casbin/casdoor:latest
    ports:
      - "8000:8000"
    volumes:
      - ./docker/casdoor/app.conf:/conf/app.conf:ro
      - ./docker/casdoor/init_data.json:/conf/init_data.json:ro
      - casdoor_data:/data
    restart: unless-stopped

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    command:
      - --http-address=0.0.0.0:4180
      - --provider=oidc
      - --oidc-issuer-url=http://casdoor:8000
      - --login-url=http://localhost:8000/login/oauth/authorize
      - --redeem-url=http://casdoor:8000/api/login/oauth/access_token
      - --oidc-jwks-url=http://casdoor:8000/.well-known/jwks
      - --insecure-oidc-skip-issuer-verification=true
      - --redirect-url=https://localhost/oauth2/callback
      - --client-id=${CASDOOR_CLIENT_ID}
      - --client-secret=${CASDOOR_CLIENT_SECRET}
      - --cookie-secret=${OAUTH2_PROXY_COOKIE_SECRET}
      - --email-domain=*
      - --upstream=static://202
      - --reverse-proxy=true
      - --skip-provider-button=true
      - --cookie-secure=true
      - --scope=openid profile email
    expose:
      - "4180"
    depends_on:
      - casdoor
    restart: unless-stopped

  socat-frontend:
    image: alpine/socat
    command: tcp-listen:8020,fork,reuseaddr tcp-connect:host.docker.internal:8020
    extra_hosts:
      - "host.docker.internal:host-gateway"
    expose:
      - "8020"
    restart: unless-stopped

  socat-backend:
    image: alpine/socat
    command: tcp-listen:4001,fork,reuseaddr tcp-connect:host.docker.internal:4001
    extra_hosts:
      - "host.docker.internal:host-gateway"
    expose:
      - "4001"
    restart: unless-stopped

volumes:
  caddy_data:
  casdoor_data:
